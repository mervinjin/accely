datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator typegraphql {
  provider = "typegraphql-prisma"
}

/// 用户
model User {
  id       Int      @id @default(autoincrement())
  username String   @unique
  password String
  nickname String
  updateAt DateTime @updatedAt

  /// 用户账户信息
  accounts Account[]
  spaces   Space[]
}

/// 账户类型
enum AccountType {
  /// 支付账户
  Payment
  /// 信用账户
  Credit
  /// 资产
  Assets
}

/// 账户
model Account {
  id         Int         @id @default(autoincrement())
  userId     Int
  currencyId Int
  name       String
  balance    Float       @default(0)
  type       AccountType
  updateAt   DateTime    @updatedAt

  user                 User          @relation(fields: [userId], references: [id])
  paymentTransaction   Transaction[] @relation("PaymentTransactionRelation")
  receivingTransaction Transaction[] @relation("ReceivingTransactionRelation")
}

/// 空间
model Space {
  id       Int      @id @default(autoincrement())
  name     String
  updateAt DateTime @updatedAt

  users       User[]
  tags        Tag[]
  Transaction Transaction[]
}

/// 标签
model Tag {
  id       Int      @id @default(autoincrement())
  /// 父标签
  parentId Int?
  /// 所属空间
  spaceId  Int
  /// 标签名称
  name     String
  updateAt DateTime @updatedAt

  parent       Tag?          @relation("TagToTag", fields: [parentId], references: [id])
  childrens    Tag[]         @relation("TagToTag")
  space        Space         @relation(fields: [spaceId], references: [id])
  transactions Transaction[]
}

/// 交易类型
enum TransactionType {
  /// 支出
  Payment
  /// 收入
  Income
  /// 转账
  Transfer
  /// 债务
  Debt
}

/// 交易记录
model Transaction {
  id                 Int             @id @default(autoincrement())
  /// 所属空间
  spaceId            Int
  /// 标签（非聚合交易）
  tagId              Int?
  /// 付款账户
  paymentAccountId   Int?
  /// 收款账户/债务账户
  receivingAccountId Int?
  /// 交易类型
  type               TransactionType
  /// 金额/本金
  amount             Float
  /// 还款利息
  interest           Float?
  updateAt           DateTime        @updatedAt

  space            Space    @relation(fields: [spaceId], references: [id])
  tags             Tag[]
  paymentAccount   Account? @relation(name: "PaymentTransactionRelation", fields: [paymentAccountId], references: [id])
  receivingAccount Account? @relation(name: "ReceivingTransactionRelation", fields: [receivingAccountId], references: [id])
}
